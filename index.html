<html>
    <head>
        <link rel="stylesheet" type="text/css" href="resources/styles/style-dark.css">
        <link rel="stylesheet" type="text/css" href="resources/styles/main.css">
        <link href="resources/styles/material-icons.css" rel="stylesheet">
        <link rel="stylesheet" href="resources/styles/materialize.css">
        <link href="https://unpkg.com/regex-colorize/themes/default.css" rel="stylesheet">
        <script src="resources/jquery-3.5.1.min.js"></script>
        <script src="db-diagram.js"></script>
        <script src="fields.js"></script>
        <script src="tables.js"></script>
        <script src="fieldSettings.js"></script>
        <script src="relationSettings.js"></script>
        <script src="tableRules.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.7.1/jquery.contextMenu.min.css">
        <script src="resources/jquery.contextMenu.min.js"></script>
        <script src="resources/materialize.min.js"></script>
        <script src="//unpkg.com/regex-colorize"></script>
    </head>
    <body>
        <div id="mydiv" style="width: 100%; height:100%; overflow: scroll"></div>
        <code class="regex">/^[A-Za-z0-9]+(?:[ _-][A-Za-z0-9]+)*$/</code>
        <div class="dropdown">
            <div class="menu-content">
            <ul>
                <li id="edit_table"><i class="material-icons menu-icon">edit</i> <span>Edit Table</<span></li>
                <li id="add_field"><i class="material-icons menu-icon">add</i> Add Field</li>
                <li id="manage_fields"><i class="material-icons menu-icon">settings</i> Manage Fields</li>
                <li id="manage_relations"><i class="material-icons menu-icon">insert_link</i> Manage Relations</li>
                <li id="table_rules"><i class="material-icons menu-icon">rule</i> Table Rules</li>
                <li id="remove_table">
                    <i class="material-icons menu-icon">remove_circle</i>
                    Remove Table
                </li>
            </ul>
            </div>
            <div class="arrow"></div>
        </div>
        <div class="popup" id="new_field" data-name="">
            <div class="popup-container" id="fields">

            </div>
        </div>
        <div class="popup" id="table">
            <div class="popup-container" id="tableEditor">
                
            </div>
        </div>
        <div class="popup" id="field_settings" data-name="" style="overflow-y: auto;">
            <div class="popup-container" id="field_settings_container" style="height: 100%; margin: auto;">
                
            </div>
        </div>
        <div class="popup" id="relation_settings" data-name="" style="overflow-y: auto;">
            <div class="popup-container" id="relation_settings_container" style="height: 100%; margin: auto;">
                
            </div>
        </div>
        <div class="popup" id="rule_settings" data-name="" style="overflow-y: auto;">
            <div class="popup-container" id="rule_settings_container" style="height: 110%; margin: auto;">
                
            </div>
        </div>
        <!-- Table Remove Confirmation Modal -->
        <div class="popup" id="table_remove" style="display: none; height: min-content; overflow: hidden;">
            <div class="popup-container" id="table_remove" style="padding: 10px;">
                <div class="modal-content">
                    <h5>Are you sure you want to remove this table?</h5>
                    <p style="padding-bottom: 20px;">Note: All data related to the table will be remove, including the foreign constraints and relations.</p>
                </div>
                <div class="modal-footer">
                    <a href="#!" style="background-color: lightslategrey;" id="confirm_table_remove" class="waves-effect waves-green btn-flat">Remove</a>
                    <a href="#!" style="background-color: firebrick;" id="cancel_table_remove" class="waves-effect waves-green btn-flat">Cancel</a>
                </div>
            </div>
        </div>
        <script>
            //let data = `{"id":1,"name":"API Name","application":"Application ID","owner":"Account Name","version":"v1.5","level":2,"environment":"prod","security":"REST Api Security Type","description":"Description of the API","meta":{"createdAt":"datetime","lastUpdatedAt":"datetime","createdBy":"Creator","lastUpdatedBy":"Updater"},"rest":true,"graphql":false,"tables":[{"name":"test","description":"Tests of students","meta":{"createdAt":"datetime","lastUpdatedAt":"datetime","createdBy":"Creator","lastUpdatedBy":"Updater","positionX":50,"positionY":85,"color":"color of the table"},"methods":["GET","POST","DELETE","PUT","HEAD","PATCH","OPTIONS"],"requiresAuth":[{"method":"GET","authEntity":"users"},{"method":"POST","authEntity":"users"},{"method":"PUT","authEntity":"users"}],"pagination":true,"columns":[{"name":"id","type":"int","size":"","foreign":false,"reference":null,"foreignKey":null,"autoIncrement":true,"id":true,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":true},{"name":"score","type":"int","size":"","foreign":false,"reference":null,"foreignKey":null,"autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":true},{"name":"student","type":"int","size":"","foreign":true,"reference":"student","foreignKey":"id","autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":false},{"name":"paper","type":"text","size":"","foreign":false,"reference":"","foreignKey":"","autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":false,"file":true,"fileTypes":["document","image"],"fileExtensions":["txt","jpeg","jpg","pdf"],"fileMinSize":2000,"fileMaxSize":5000000}],"primaryKey":"id","identifier":"id","auth":false,"jwt_expires":false,"jwt_duration":0,"traits":["uuid","blameable","timestampable","softdeletable"],"search":{"fulltext":[],"soundex":[],"exact":[],"like":[]},"rules":[{"method":"GET","leftValue":"resource.score","rightValue":15,"operator":">"}]},{"name":"student","description":"Description of the table","meta":{"createdAt":"datetime","lastUpdatedAt":"datetime","createdBy":"Creator","lastUpdatedBy":"Updater","positionX":160,"positionY":340,"color":"color of the table"},"methods":["GET","POST","DELETE","PUT","HEAD","PATCH","OPTIONS"],"pagination":true,"columns":[{"name":"id","type":"int","size":"","foreign":false,"reference":null,"foreignKey":null,"autoIncrement":true,"id":true,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":true},{"name":"name","type":"varchar","size":100,"foreign":false,"reference":null,"foreignKey":null,"autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":false},{"name":"family","type":"int","size":"","foreign":true,"reference":"family","foreignKey":"id","autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":false}],"primaryKey":"id","identifier":"id","auth":false,"traits":["uuid","blameable","timestampable","softdeletable"],"search":{"fulltext":["brand"],"soundex":["brand"],"exact":[],"like":["brand"],"levenshtein":["brand"]},"rules":[{"method":"GET","leftValue":"test[score>15].student[name='karam'].parent[type='father'].name","rightValue":"\\"rachid aachich\\"","operator":"contains"}]},{"name":"family","description":"Description of the table","meta":{"createdAt":"datetime","lastUpdatedAt":"datetime","createdBy":"Creator","lastUpdatedBy":"Updater","positionX":450,"positionY":220,"color":"color of the table"},"methods":["GET","POST","DELETE","PUT","HEAD","PATCH","OPTIONS"],"pagination":true,"columns":[{"name":"id","type":"int","size":"","foreign":false,"reference":null,"foreignKey":null,"autoIncrement":true,"id":true,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":true},{"name":"name","type":"varchar","size":100,"foreign":false,"reference":null,"foreignKey":null,"autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":false}],"primaryKey":"id","identifier":"id","auth":false,"traits":["uuid","blameable","timestampable","softdeletable"],"search":{"fulltext":["brand"],"soundex":["brand"],"exact":[],"like":["brand"],"levenshtein":["brand"]},"rules":[{"method":"GET","rulestring":"The rule string, logical condition that shall return true in order to proceed in action"}]},{"name":"parent","description":"Description of the table","meta":{"createdAt":"datetime","lastUpdatedAt":"datetime","createdBy":"Creator","lastUpdatedBy":"Updater","positionX":800,"positionY":500,"color":"color of the table"},"methods":["GET","POST","DELETE","PUT","HEAD","PATCH","OPTIONS"],"pagination":true,"columns":[{"name":"id","type":"int","size":"","foreign":false,"reference":null,"foreignKey":null,"autoIncrement":true,"id":true,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":true},{"name":"name","type":"varchar","size":100,"foreign":false,"reference":null,"foreignKey":null,"autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":false},{"name":"type","type":"varchar","size":50,"foreign":false,"reference":"","foreignKey":"","autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":false},{"name":"family","type":"int","size":"","foreign":true,"reference":"family","foreignKey":"id","autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":false}],"primaryKey":"id","identifier":"id","auth":false,"traits":["uuid","blameable","timestampable","softdeletable"],"search":{"fulltext":["brand"],"soundex":["brand"],"exact":[],"like":["brand"],"levenshtein":["brand"]},"rules":[{"method":"GET","rulestring":"The rule string, logical condition that shall return true in order to proceed in action"}]},{"name":"users","description":"User login table","meta":{"createdAt":"datetime","lastUpdatedAt":"datetime","createdBy":"Creator","lastUpdatedBy":"Updater","positionX":1024,"positionY":730,"color":"color of the table"},"methods":["GET","POST","DELETE","PUT","HEAD","PATCH","OPTIONS"],"pagination":false,"columns":[{"name":"id","type":"int","size":"","foreign":false,"reference":null,"foreignKey":null,"autoIncrement":true,"id":true,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":true},{"name":"username","type":"varchar","size":100,"foreign":false,"reference":null,"foreignKey":null,"autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":true,"password":false,"unique":true},{"name":"password","type":"varchar","size":50,"foreign":false,"reference":"","foreignKey":"","autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":true,"unique":false},{"name":"email","type":"varchar","size":100,"foreign":false,"reference":"","foreignKey":"","autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":true,"password":false,"unique":true}],"primaryKey":"id","identifier":"id","auth":true,"requirePassOnUpdate":true,"jwt_expires":true,"jwt_duration":30,"traits":["uuid","blameable","timestampable","softdeletable"],"search":{"fulltext":["username","email"],"soundex":["username"],"exact":["username","email"],"like":["username"]},"rules":[{"method":"GET","leftValue":"currentuser.type","rightValue":"\\"admin\\"","operator":"=="},{"method":"GET","leftValue":"resource.id","rightValue":"currentuser.id","operator":"=="}]}],"relations":[{"original":"test","foreign":"student","primaryKey":"id","foreignKey":"student","type":"OneToOne"},{"original":"student","foreign":"parent","primaryKey":"","foreignKey":"","middletable":"student_parents","type":"ManyToMany"},{"original":"parent","foreign":"family","primaryKey":"id","foreignKey":"family","type":"ManyToOne"}]}`;
            //let data = `{"id":1,"name":"API Name","application":"Application ID","owner":"Account Name","version":"v1.5","level":2,"environment":"prod","security":"REST Api Security Type","description":"Description of the API","meta":{"createdAt":"datetime","lastUpdatedAt":"datetime","createdBy":"Creator","lastUpdatedBy":"Updater"},"rest":true,"graphql":false,"tables":[{"name":"test","description":"Tests of students","meta":{"createdAt":"datetime","lastUpdatedAt":"datetime","createdBy":"Creator","lastUpdatedBy":"Updater","positionX":50,"positionY":85,"color":"color of the table"},"methods":["GET","POST","DELETE","PUT","HEAD","PATCH","OPTIONS"],"requiresAuth":[{"method":"GET","authEntity":"users"},{"method":"POST","authEntity":"users"},{"method":"PUT","authEntity":"users"}],"pagination":true,"columns":[{"name":"id","type":"int","size":"","foreign":false,"reference":null,"foreignKey":null,"autoIncrement":true,"id":true,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":true},{"name":"score","type":"int","size":"","foreign":false,"reference":null,"foreignKey":null,"autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":true},{"name":"student","type":"int","size":"","foreign":true,"reference":"student","foreignKey":"id","autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":false},{"name":"paper","type":"text","size":"","foreign":false,"reference":"","foreignKey":"","autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":false,"file":true,"fileTypes":["document","image"],"fileExtensions":["txt","jpeg","jpg","pdf"],"fileMinSize":2000,"fileMaxSize":5000000}],"primaryKey":"id","identifier":"id","auth":false,"jwt_expires":false,"jwt_duration":0,"traits":["uuid","blameable","timestampable","softdeletable"],"search":{"fulltext":[],"soundex":[],"exact":[],"like":[]},"rules":[{"method":"GET","leftValue":"resource.score","rightValue":15,"operator":">"}]},{"name":"student","description":"Description of the table","meta":{"createdAt":"datetime","lastUpdatedAt":"datetime","createdBy":"Creator","lastUpdatedBy":"Updater","positionX":160,"positionY":340,"color":"color of the table"},"methods":["GET","POST","DELETE","PUT","HEAD","PATCH","OPTIONS"],"pagination":true,"columns":[{"name":"id","type":"int","size":"","foreign":false,"reference":null,"foreignKey":null,"autoIncrement":true,"id":true,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":true},{"name":"name","type":"varchar","size":100,"foreign":false,"reference":null,"foreignKey":null,"autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":false},{"name":"family","type":"int","size":"","foreign":true,"reference":"family","foreignKey":"id","autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":false}],"primaryKey":"id","identifier":"id","auth":false,"traits":["uuid","blameable","timestampable","softdeletable"],"search":{"fulltext":["brand"],"soundex":["brand"],"exact":[],"like":["brand"],"levenshtein":["brand"]},"rules":[{"method":"GET","leftValue":"test[score>15].student[name='karam'].parent[type='father'].name","rightValue":"\\"rachid aachich\\"","operator":"contains"}]},{"name":"family","description":"Description of the table","meta":{"createdAt":"datetime","lastUpdatedAt":"datetime","createdBy":"Creator","lastUpdatedBy":"Updater","positionX":450,"positionY":220,"color":"color of the table"},"methods":["GET","POST","DELETE","PUT","HEAD","PATCH","OPTIONS"],"pagination":true,"columns":[{"name":"id","type":"int","size":"","foreign":false,"reference":null,"foreignKey":null,"autoIncrement":true,"id":true,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":true},{"name":"name","type":"varchar","size":100,"foreign":false,"reference":null,"foreignKey":null,"autoIncrement":false,"id":false,"uuid":false,"default":null,"null":true,"login":false,"password":false,"unique":false}],"primaryKey":"id","identifier":"id","auth":false,"traits":["uuid","blameable","timestampable","softdeletable"],"search":{"fulltext":["brand"],"soundex":["brand"],"exact":[],"like":["brand"],"levenshtein":["brand"]},"rules":[{"method":"GET","rulestring":"The rule string, logical condition that shall return true in order to proceed in action"}]},{"name":"parent","description":"Description of the table","meta":{"createdAt":"datetime","lastUpdatedAt":"datetime","createdBy":"Creator","lastUpdatedBy":"Updater","positionX":800,"positionY":500,"color":"color of the table"},"methods":["GET","POST","DELETE","PUT","HEAD","PATCH","OPTIONS"],"pagination":true,"columns":[{"name":"id","type":"int","size":"","foreign":false,"reference":null,"foreignKey":null,"autoIncrement":true,"id":true,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":true},{"name":"name","type":"varchar","size":100,"foreign":false,"reference":null,"foreignKey":null,"autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":false},{"name":"type","type":"varchar","size":50,"foreign":false,"reference":"","foreignKey":"","autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":false},{"name":"family","type":"int","size":"","foreign":true,"reference":"family","foreignKey":"id","autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":false}],"primaryKey":"id","identifier":"id","auth":false,"traits":["uuid","blameable","timestampable","softdeletable"],"search":{"fulltext":["brand"],"soundex":["brand"],"exact":[],"like":["brand"],"levenshtein":["brand"]},"rules":[{"method":"GET","rulestring":"The rule string, logical condition that shall return true in order to proceed in action"}]},{"name":"users","description":"User login table","meta":{"createdAt":"datetime","lastUpdatedAt":"datetime","createdBy":"Creator","lastUpdatedBy":"Updater","positionX":1024,"positionY":730,"color":"color of the table"},"methods":["GET","POST","DELETE","PUT","HEAD","PATCH","OPTIONS"],"pagination":false,"columns":[{"name":"id","type":"int","size":"","foreign":false,"reference":null,"foreignKey":null,"autoIncrement":true,"id":true,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":true},{"name":"username","type":"varchar","size":100,"foreign":false,"reference":null,"foreignKey":null,"autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":true,"password":false,"unique":true},{"name":"password","type":"varchar","size":50,"foreign":false,"reference":"","foreignKey":"","autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":true,"unique":false},{"name":"email","type":"varchar","size":100,"foreign":false,"reference":"","foreignKey":"","autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":true,"password":false,"unique":true}],"primaryKey":"id","identifier":"id","auth":true,"requirePassOnUpdate":true,"jwt_expires":true,"jwt_duration":30,"traits":["uuid","blameable","timestampable","softdeletable"],"search":{"fulltext":["username","email"],"soundex":["username"],"exact":["username","email"],"like":["username"]},"rules":[{"method":"GET","leftValue":"currentuser.type","rightValue":"\\"admin\\"","operator":"=="},{"method":"GET","leftValue":"resource.id","rightValue":"currentuser.id","operator":"=="}]}],"relations":[{"original":"test","foreign":"student","primaryKey":"id","foreignKey":"student","type":"OneToOne"},{"original":"student","foreign":"parent","primaryKey":"","foreignKey":"","middletable":"student_parents","type":"ManyToMany"},{"original":"parent","foreign":"family","primaryKey":"id","foreignKey":"family","type":"ManyToOne"}]}`;
            let data = `{"id":1,"name":"API Name","application":"Application ID","owner":"Account Name","version":"v1.5","level":2,"environment":"prod","security":"REST Api Security Type","description":"Description of the API","meta":{"createdAt":"datetime","lastUpdatedAt":"datetime","createdBy":"Creator","lastUpdatedBy":"Updater"},"rest":true,"graphql":false,"tables":[{"name":"test","description":"Tests of students","meta":{"createdAt":"datetime","lastUpdatedAt":"datetime","createdBy":"Creator","lastUpdatedBy":"Updater","positionX":50,"positionY":85,"color":"color of the table"},"methods":["GET","POST","DELETE","PUT","HEAD","PATCH","OPTIONS"],"requiresAuth":[{"method":"GET","authEntity":"users"},{"method":"POST","authEntity":"users"},{"method":"PUT","authEntity":"users"}],"pagination":true,"columns":[{"name":"id","type":"int","size":"","foreign":false,"reference":null,"foreignKey":null,"autoIncrement":true,"id":true,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":true},{"name":"score","type":"int","size":"","foreign":false,"reference":null,"foreignKey":null,"autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":true,"regex":[{"rule":"ddddddd","message":"score cannot be a string"}]},{"name":"student","type":"int","size":"","foreign":true,"reference":"student","foreignKey":"id","autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":false},{"name":"paper","type":"text","size":"","foreign":false,"reference":"","foreignKey":"","autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":false,"file":true,"fileTypes":["document","image"],"fileExtensions":["txt","jpeg","jpg","pdf"],"fileMinSize":2000,"fileMaxSize":5000000}],"primaryKey":"id","identifier":"id","auth":false,"jwt_expires":false,"jwt_duration":0,"traits":["uuid","blameable","timestampable","softdeletable"],"search":{"fulltext":[],"soundex":[],"exact":[],"like":[]},"rules":[{"method":"GET","leftValue":"resource.score","rightValue":15,"operator":">"}]},{"name":"student","description":"Description of the table","meta":{"createdAt":"datetime","lastUpdatedAt":"datetime","createdBy":"Creator","lastUpdatedBy":"Updater","positionX":160,"positionY":340,"color":"color of the table"},"methods":["GET","POST","DELETE","PUT","HEAD","PATCH","OPTIONS"],"pagination":true,"columns":[{"name":"id","type":"int","size":"","foreign":false,"reference":null,"foreignKey":null,"autoIncrement":true,"id":true,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":true},{"name":"name","type":"varchar","size":100,"foreign":false,"reference":null,"foreignKey":null,"autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":false},{"name":"family","type":"int","size":"","foreign":true,"reference":"family","foreignKey":"id","autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":false}],"primaryKey":"id","identifier":"id","auth":false,"traits":["uuid","blameable","timestampable","softdeletable"],"search":{"fulltext":["brand"],"soundex":["brand"],"exact":[],"like":["brand"],"levenshtein":["brand"]},"rules":[{"method":"GET","leftValue":"test[score>15].student[name='karam'].parent[type='father'].name","rightValue":"\\"rachid aachich\\"","operator":"contains"}]},{"name":"family","description":"Description of the table","meta":{"createdAt":"datetime","lastUpdatedAt":"datetime","createdBy":"Creator","lastUpdatedBy":"Updater","positionX":450,"positionY":220,"color":"color of the table"},"methods":["GET","POST","DELETE","PUT","HEAD","PATCH","OPTIONS"],"pagination":true,"columns":[{"name":"id","type":"int","size":"","foreign":false,"reference":null,"foreignKey":null,"autoIncrement":true,"id":true,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":true},{"name":"name","type":"varchar","size":100,"foreign":false,"reference":null,"foreignKey":null,"autoIncrement":false,"id":false,"uuid":false,"default":null,"null":true,"login":false,"password":false,"unique":false}],"primaryKey":"id","identifier":"id","auth":false,"traits":["uuid","blameable","timestampable","softdeletable"],"search":{"fulltext":["brand"],"soundex":["brand"],"exact":[],"like":["brand"],"levenshtein":["brand"]},"rules":[{"method":"GET","rulestring":"The rule string, logical condition that shall return true in order to proceed in action"}]},{"name":"parent","description":"Description of the table","meta":{"createdAt":"datetime","lastUpdatedAt":"datetime","createdBy":"Creator","lastUpdatedBy":"Updater","positionX":800,"positionY":500,"color":"color of the table"},"methods":["GET","POST","DELETE","PUT","HEAD","PATCH","OPTIONS"],"pagination":true,"columns":[{"name":"id","type":"int","size":"","foreign":false,"reference":null,"foreignKey":null,"autoIncrement":true,"id":true,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":true},{"name":"name","type":"varchar","size":100,"foreign":false,"reference":null,"foreignKey":null,"autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":false},{"name":"type","type":"varchar","size":50,"foreign":false,"reference":"","foreignKey":"","autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":false},{"name":"family","type":"int","size":"","foreign":true,"reference":"family","foreignKey":"id","autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":false}],"primaryKey":"id","identifier":"id","auth":false,"traits":["uuid","blameable","timestampable","softdeletable"],"search":{"fulltext":["brand"],"soundex":["brand"],"exact":[],"like":["brand"],"levenshtein":["brand"]},"rules":[{"method":"GET","rulestring":"The rule string, logical condition that shall return true in order to proceed in action"}]},{"name":"users","description":"User login table","meta":{"createdAt":"datetime","lastUpdatedAt":"datetime","createdBy":"Creator","lastUpdatedBy":"Updater","positionX":1024,"positionY":730,"color":"color of the table"},"methods":["GET","POST","DELETE","PUT","HEAD","PATCH","OPTIONS"],"pagination":false,"columns":[{"name":"id","type":"int","size":"","foreign":false,"reference":null,"foreignKey":null,"autoIncrement":true,"id":true,"uuid":false,"default":null,"null":false,"login":false,"password":false,"unique":true},{"name":"username","type":"varchar","size":100,"foreign":false,"reference":null,"foreignKey":null,"autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":true,"password":false,"unique":true},{"name":"password","type":"varchar","size":50,"foreign":false,"reference":"","foreignKey":"","autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":false,"password":true,"unique":false},{"name":"email","type":"varchar","size":100,"foreign":false,"reference":"","foreignKey":"","autoIncrement":false,"id":false,"uuid":false,"default":null,"null":false,"login":true,"password":false,"unique":true}],"primaryKey":"id","identifier":"id","auth":true,"requirePassOnUpdate":true,"jwt_expires":true,"jwt_duration":30,"traits":["uuid","blameable","timestampable","softdeletable"],"search":{"fulltext":["username","email"],"soundex":["username"],"exact":["username","email"],"like":["username"]},"rules":[{"method":"GET","leftValue":"currentuser.type","rightValue":"\\"admin\\"","operator":"=="},{"method":"GET","leftValue":"resource.id","rightValue":"currentuser.id","operator":"=="}]}],"relations":[{"original":"test","foreign":"student","primaryKey":"id","foreignKey":"student","type":"OneToOne"},{"original":"student","foreign":"parent","primaryKey":"","foreignKey":"","middletable":"student_parents","type":"ManyToMany"},{"original":"parent","foreign":"family","primaryKey":"id","foreignKey":"family","type":"ManyToOne"}]}`;
            // data = data.replace("\"", "\\\"");
            window.api = JSON.parse(data);
            window.store = new Object();
            $(document).ready(function() {
                $('select').formSelect();
                DBDiagram.onDomReady(async () => {
                    await DBDiagram.addIconSet("icons.svg");
                    var diagram = new DBDiagram.Diagram({width: '2000px', height: '1500px'}).attach("#mydiv");
                    /*const data = await fetch('https://storage.googleapis.com/krobkrong/sample.table.json')
                    .then((response) => {
                        if (response.ok) return response.json();
                        // handle error here  #61acec
                    });*/
                    var tables = [];
                    window.api.tables.forEach(function(tbl) {
                        /*let fields = [];
                        tbl.columns.forEach(function(column) {
                            fields.push({"name": })
                        });*/
                        let tbOpt = {"name": tbl.name};
                        /*const fields = tbl.columns.map(function(c) {
                            if(c.name == tbl.identifier)
                                c.primary = true;
                            return c;
                        });*/
                       // delete tbOpt.fields;
                        tbOpt.size = {width: 250, height: 153};
                        const table = diagram.table(tbOpt);
                        table.x(tbl.meta.positionX).y(tbl.meta.positionY);
                        tbl.columns.forEach((field) => {
                            let f = {"name": field.name, "type": field.type, "login": field.login, "unique": field.unique, "column": field};
                            if(field.name == tbl.identifier)
                                f.primary = true;
                            if(field.password)
                                f.type = "Password";
                            if(field.file)
                                f.type = "File";
                            table.addField(f);
                        });
                        table.rules = tbl.rules;
                        tables.push(table);
                    });
                    /*let data = [
                        {
                            "name": "table 1",
                            "header": {"tableIcon": "lock", "color": "#010072"},
                            "fields": [
                                {"name": "id", "type": "number", "primary": true},
                                {"name": "name", "type": "string"},
                                {"name": "email", "type": "string"},
                                {"name": "pass", "type": "password"}
                            ],
                            //"size" : {"width": "250", "height": "153"}
                        },
                        {
                            "name": "table 2",
                            "table-icon": "lock",
                            "fields": [
                                {"name": "id", "type": "number", "primary": true, "nameColor": "red"},
                                {"name": "name", "type": "string"},
                                {"name": "email", "type": "string"}
                            ]
                        },
                        {
                            "name": "table 3",
                            "header": {"tableIcon": "lock"},
                            "fields": [
                                {"name": "id", "type": "number", "primary": true},
                                {"name": "name", "type": "string"},
                                {"name": "email", "type": "string"}
                            ]
                        }
                    ];
                    var tables = [];
                    //let settingIcon = '<svg class="table-settings-icon" onclick="alert(8787)" fill="#eaeaea" transform="translate(104,5)" width="20" height="20" version="1.1" id="Capa_1" x="{xposition}px" y="7px" viewBox="0 0 384 384" style="enable-background:new 0 0 384 384;" xml:space="preserve"><g>	<g>		<circle cx="192" cy="42.667" r="42.667"/>	</g></g><g>	<g>		<circle cx="192" cy="192" r="42.667"/>	</g></g><g>	<g>		<circle cx="192" cy="341.333" r="42.667"/>	</g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g></svg>';
                    data.forEach(tbOpt => {
                        const fields = tbOpt.fields;
                        delete tbOpt.fields;
                        tbOpt.size = {width: 250, height: 153};
                        const table = diagram.table(tbOpt);
                        fields.forEach((field) => { table.addField(field) });
                        tables.push(table);
                    });*/
                
                
                    /*tables[0].x(100).y(50);
                    tables[1].x(450).y(120);
                    tables[2].x(150).y(320);*/
                    //tables[0].ne.outerHTML = '<svg xmlns="http://www.w3.org/2000/svg" version="1.1" style="width: 300px; height: 250px"><rect x="50" y="20" rx="10" ry="10" width="200" height="200" style="fill:red; stroke:black; stroke-width:3" id="rect" data-name="table 1" /></svg>';
                        //console.log(tables[0].ne.innerHTML);
                    
                    /*tables[0].onPositionChange = function(pointer) {
                        console.log(pointer);
                        console.log(tables[0].size);
                        let cover = $("#mysvg");
                        cover.css('left', pointer.x);
                        cover.css('top', pointer.y);
                    };*/

                    //newTable.changeName("fff");
                   // tables[0].addField({"name": "dddd", "type": "file"});

                    window.store.relations = [];

                    window.api.relations.forEach(function(relation) {
                        
                        let originTable = tables.find(function(table) {
                            return table.name == relation.original;
                        });
                        let foreignTable = tables.find(function(table) {
                            return table.name == relation.foreign;
                        });


                        let primaryKey = foreignTable.fieldsUi.find(function(field) {
                            return field.fieldOptions.name == relation.primaryKey;
                        });
                        let foreignKey = originTable.fieldsUi.find(function(field) {
                            return relation.type == 'ManyToMany' ? field.fieldOptions.primary == true : (field.fieldOptions.name == relation.foreignKey);
                        });
                        
                        let r = new DBDiagram.Relation(diagram, {
                            primaryTable: foreignTable,
                            foreignField: foreignKey.fieldOptions,
                            foreignTable: originTable,
                            foreignFieldExists: true,
                            type: relation.type.toLowerCase(),
                            line: true,
                            weak: relation.type == 'ManyToMany'
                        });
                        window.store.relations.push(r);
                    });

                    let fieldIndex = tables[1].fieldIndex({"name":"family","type":"int","foreign":true,"unique":false,"typeRaw":"int"});
                    //console.log(fieldIndex);

                  /*  const relation1 = new DBDiagram.Relation(diagram, {
                        primaryTable: tables[0],
                        foreignField: tables[1].field(2),
                        foreignTable: tables[1],
                        foreignFieldExists: true,
                        line: true,
                        weak: false
                    });
                    const relation2 = new DBDiagram.Relation(diagram, {
                        primaryTable: tables[2],
                       // foreignField: {foreign: true, name: "email", type: "number", typeRaw: "number"},
                        foreignTable: tables[1],
                        line: false,
                        weak: true,
                        relationType: true,
                        straightLine: true
                    });*/

                    
                    tables[1].onPointerUp = function() {
                        //e.preventDefault();
                        //alert('jio');
                    };

                   /* 
                    Need to rethink this, probably the best way to do it is by an SVG element
                    tables.forEach(table => {
                        let settingXPosition = table.size.width - 20;
                        postionedSettingIcon = settingIcon.replace('{xposition}', settingXPosition);
                        let el = $('<g class="wrapped">' + table.ne.innerHTML + '</g>');
                        el.append(postionedSettingIcon);
                        table.ne.innerHTML = el.html();
                    });*/
                    
                    function unselectAllTables(tables) {
                        if (tables) {
                            tables.forEach(function (table) {
                                table.select(false);
                            });
                        }
                        
                        return true;
                    }
                    
                    function followTable(selected) {
                        let x = (selected.transformMatrix.e + selected.size.width + 15) - $("#mydiv").scrollLeft();
                        let y = (selected.transformMatrix.f + 0) - $("#mydiv").scrollTop();
                        $(".dropdown").attr('data-name', selected.tableOptions.name);
                        $(".dropdown").css('left', x);
                        $(".dropdown").css('top', y);
                        $(".dropdown").show();
                    }

                    diagram.onTableSelected = function(selected) {
                        if (this.tables) {
                            this.tables.forEach(function (table) {
                                if (table !== selected) {
                                    table.select(false);
                                }
                            });
                        }

                        followTable(selected);
                    };
                    
                    $( "#mydiv" ).scroll(function() {
                        $(".dropdown").fadeOut();
                        unselectAllTables(diagram.tables);
                    });
                    
                    tables.forEach(function (table) {
                        table.onPositionChange = function(p) {
                            this.fieldsUi.forEach(function (item) {
                                if (item.relation && item.relation.length > 0) {
                                    item.relation.forEach(function (relation) {
                                        relation.render();
                                    });
                                }
                            });
                            
                            this.positionx = p.x;
                            this.positiony = p.y;
                            if(this.selected)
                                followTable(this);
                        }
                    });
                    
                    $(".dbdg").click(function() {
                        $(".dropdown").hide();
                        $(".popup").hide();
                    });
                    
                    let arrow = $('.arrow');
                    let menuFirstElement = $(".menu-content").find('ul').children(":first");
                    menuFirstElement.hover(function() {
                        arrow.css('border-right-color', '#8253D7');
                    }, function() {
                        // on mouseout, reset the background colour
                        arrow.css('border-right-color', '#f1f1f1');
                    });
                    
                    
                    $.contextMenu({
                        selector: '.dbdg', 
                        callback: function(key, options) {
                            var currentMousePos = { x: -1, y: -1 };
                            $(document).mousemove(function(event) {
                                currentMousePos.x = event.pageX;
                                currentMousePos.y = event.pageY;
                            });
                            $("#tableEditor").tableEditor();
                            $("#tableEditor").onNewTable(function(tbOpt) {
                                console.log("tables", tables);
                                const tableExists = tables.some(tbl => tbl.name === tbOpt.name);
                                if(tableExists)
                                    return false;
                                const fields = tbOpt.fields;
                                delete tbOpt.fields;
                                const table = diagram.table(tbOpt);
                                fields.forEach((field) => { table.addField(field) });
                                table.x(window.contextClickX).y(window.contextClickY);
                                table.draggable(true);
                                table.selectable(true);
                                tables.push(table);
                                $("#table").hide();
                                return true;
                            });
                            $("#table").show();
                        },
                        items: {
                            "new": {name: "New Table", icon: "edit"},
                        }
                    });
                    
                    $(".dbdg").on("contextmenu", function(e) {
                        e.preventDefault();
                        window.contextClickX = e.pageX;
                        window.contextClickY = e.pageY;
                    });
                    
                    
                    var clicked = false, clickY;
                    
                    /*diagram.onDragMove = function(p) {
                        console.log(p);
                        $('html').css('cursor', 'row-resize');
                        $(window).scrollTop($(window).scrollTop() + (50 - p.point.y));
                    };
                    $(document).on({
                        'mousemove': function(e) {
                            clicked && updateScrollPos(e);
                        },
                        'mousedown': function(e) {
                            clicked = true;
                            clickY = e.pageY;
                        },
                        'mouseup': function() {
                            clicked = false;
                            $('html').css('cursor', 'auto');
                        }
                    });*/

                    var updateScrollPos = function(e) {
                        $('html').css('cursor', 'row-resize');
                        $(window).scrollTop($(window).scrollTop() + (clickY - e.pageY));
                    }
                    
                    $('#rule_chips').chips(
                        {
                            onChipAdd: function() { $("#rule_chips").show(); },
                            onChipDelete: function() {
                                if($("#rule_chips").children().length <= 1)
                                    $("#rule_chips").hide();
                            }
                        }
                    );

                    $("#rule_chips").find("input").prop("disabled", true );

                    $("#fields").onFieldSave(function(field) {
                        let tableName = $("#fields").parent().attr('data-name');
                        diagram.tables.map(function(table) {
                            if(table.name == tableName) {
                                let error = false;
                                table.fieldsUi.forEach(function(f) {
                                    if(field.name == f.fieldOptions.name) {
                                        $("#fields").error("Field name already used in this table", "fieldName");
                                        error = true;
                                        return false;
                                    }

                                    if(field.type == "Password" && f.fieldOptions.type == "Password") {
                                        $("#fields").error("A Password field already exists", "is_password");
                                        error = true;
                                        return false;
                                    }

                                    if(field.login && f.fieldOptions.login) {
                                        $("#fields").error("A Login field already exists", "is_login");
                                        error = true;
                                        return false;
                                    }
                                });
                                if(!error) {
                                    table.addField(field);
                                    $("#fields").reset();
                                    $("#fields").parent().hide();
                                }
                            }
                            return table;
                        });
                    });

                    $("#add_field").click(function() {
                        $("#fields").fields();
                        let tableName = $(this).parent().parent().parent().attr('data-name');
                        $("#new_field").attr('data-name', tableName);
                        $("#new_field").show();
                    });

                    $("#edit_table").click(function() {
                        let tableName = $(this).parent().parent().parent().attr('data-name');
                        $("#table").attr('data-name', tableName);
                        let table = diagram.tables.find(function(table) {
                            return table.name == tableName;
                        });
                        $("#tableEditor").tableEditor(table);
                        $("#tableEditor").onTableUpdate(function(tbl) {

                        });
                        $("#table").show();
                    });

                    $("#manage_fields").click(function() {
                        let tableName = $(this).parent().parent().parent().attr('data-name');
                        $("#field_settings").attr('data-name', tableName);
                        let table = diagram.tables.find(function(table) {
                            return table.name == tableName;
                        });
                        $("#field_settings_container").fieldSettings(table);
                        $("#field_settings_container").onFieldEdit(function(field) {
                            $("#field_settings").hide();
                            $("#new_field").show();
                            $("#fields").fields(field);
                            $("#fields").onGoBack(function() {
                                $("#manage_fields").trigger( "click" );
                            });

                            $("#fields").onFieldSave(function(field) {
                                diagram.tables.map(function(tbl) {
                                    if(tbl.name == table.name) {
                                        let error = false;
                                        tbl.fieldsUi.forEach(function(f, index) {
                                            if(field.original_name == f.fieldOptions.name) {
                                               // tbl.updateField(index, field);
                                                
                                                let v = tbl.updateField(index, field);
                                                let primaryTable = null;
                                                let relationType = null;
                                                let relationWeak = false;
                                                let relationLine = false;
                                                if (f.relation && f.relation.length > 0) {
                                                    f.relation.forEach(function (relation) {
                                                        primaryTable = relation.options.primaryTable;
                                                        relationType = relation.options.type;
                                                        relationWeak = relation.options.weak;
                                                        relationLine = relation.options.line;
                                                        relation.foriegnField = field;
                                                        relation.render().detach(diagram);
                                                    });

                                                    new DBDiagram.Relation(diagram, {
                                                        primaryTable: primaryTable,
                                                        foreignField: v.fieldOptions,
                                                        foreignTable: tbl,
                                                        foreignFieldExists: true,
                                                        type: relationType,
                                                        line: relationLine,
                                                        weak: relationWeak
                                                    });
                                                }
                                            }
                                        });
                                    }
                                    return tbl;
                                });

                                $("#manage_fields").trigger( "click" );
                                $("#form_alert").text('Field updated successfully!').show();
                            });
                        });

                        $("#field_settings_container").onFieldRemove(function(field) {
                            diagram.tables.map(function(tbl) {
                                if(tbl.name == table.name) {
                                    tbl.fieldsUi.forEach(function(f, index) {
                                        if(field.name == f.fieldOptions.name) {
                                            if (f.relation && f.relation.length > 0) {
                                                f.relation.forEach(function (relation) {
                                                    relation.render().detach(diagram);
                                                });
                                            }
                                            tbl.removeField(index);
                                        }
                                    });
                                }
                                return tbl;
                            });
                        });

                        $("#field_settings_container").onPrimaryKeyChange(function(name, isChecked) {
                            diagram.tables.map(function(tbl) {
                                
                                if(tbl.name == table.name) {
                                    tbl.fieldsUi.forEach(function(f, i) {
                                        let v =  null;
                                        if(f.fieldOptions.name == name) {
                                            f.fieldOptions.primary = isChecked;
                                            f.fieldOptions.column.primary = isChecked;
                                            v = tbl.updateField(i, f.fieldOptions);
                                        }
                                        else
                                        {
                                            f.fieldOptions.primary = false;
                                            f.fieldOptions.column.primary = false;
                                            v = tbl.updateField(i, f.fieldOptions);
                                        }

                                        let primaryTable = null;
                                        let relationType = null;
                                        let relationWeak = false;
                                        let relationLine = false;
                                        if (f.relation && f.relation.length > 0) {
                                            f.relation.forEach(function (relation) {
                                                primaryTable = relation.options.primaryTable;
                                                relationType = relation.options.type;
                                                relationWeak = relation.options.weak;
                                                relationLine = relation.options.line;
                                                relation.foriegnField = f.fieldOptions;
                                                relation.render().detach(diagram);
                                            });

                                            new DBDiagram.Relation(diagram, {
                                                primaryTable: primaryTable,
                                                foreignField: v.fieldOptions,
                                                foreignTable: tbl,
                                                foreignFieldExists: true,
                                                type: relationType,
                                                line: relationLine,
                                                weak: relationWeak
                                            });
                                        }
                                    });
                                }
                                
                                return tbl;
                            });
                        });

                        $("#field_settings").show();
                    });

                    $("#manage_relations").click(function() {
                        let tableName = $(this).parent().parent().parent().attr('data-name');
                        $("#relation_settings").attr('data-name', tableName);
                        let table = diagram.tables.find(function(table) {
                            return table.name == tableName;
                        });

                        $("#relation_settings_container").relationSettings(table);
                        $("#relation_settings_container").onRelationRemove(function(index) {
                            //window.api.relations.splice(index, 1);
                            console.log("rel", window.api.relations[index]);
                            let rel = window.api.relations[index];
                            window.store.relations.forEach(function(relation) {
                                console.log("relation", relation);
                                let column = relation.foriegnField.column;
                                if(rel.type.toLowerCase() == 'manytomany') {
                                    if(column.reference == null
                                    && column.foreignKey == null
                                    && rel.primaryKey == ''
                                    && rel.foreignKey == ''
                                    && (
                                            (relation.options.foreignTable.tableOptions.name == rel.original
                                            && relation.options.primaryTable.tableOptions.name == rel.foreign
                                            )
                                            ||
                                            (relation.options.foreignTable.tableOptions.name == rel.foreign
                                            && relation.options.foreignTable.tableOptions.name == rel.original
                                            )
                                        )
                                    && relation.options.type == rel.type.toLowerCase()) {
                                        relation.render().detach(diagram);
                                    }
                                } else {
                                    if(column.reference == rel.foreign
                                    && column.foreignKey == rel.primaryKey
                                    && column.name == rel.foreignKey
                                    && relation.options.foreignTable.tableOptions.name == rel.original
                                    && relation.options.type == rel.type.toLowerCase()) {
                                        relation.render().detach(diagram);
                                    }
                                }
                            })
                           // relation.render().detach(diagram);
                        });
                        $("#relation_settings").show();
                    });

                    $("#table_rules").click(function() {
                        let tableName = $(this).parent().parent().parent().attr('data-name');
                        $("#rule_settings").attr('data-name', tableName);
                        let table = diagram.tables.find(function(table) {
                            return table.name == tableName;
                        });

                        $("#rule_settings_container").tableRules(table);
                        $("#rule_settings_container").onRuleRemove(function(index) {
                            console.log("index", index);
                        });
                        $("#rule_settings_container").onRuleSave(function(rule) {
                            console.log("rule", rule);
                        });
                        $("#rule_settings").show();
                    });

                    $("#remove_table").click(function() {
                        $("#table_remove").show();
                    });

                    $("#cancel_table_remove").click(function() {
                        $("#table_remove").hide();
                    });

                    $("#confirm_table_remove").click(function() {
                        let selectedTable = diagram.tables.find((table) => table.selected);
                        if (selectedTable) {
                            selectedTable.fieldsUi.forEach(function(f, index) {
                                if (f.relation && f.relation.length > 0) {
                                    f.relation.forEach(function (relation) {
                                        relation.render().detach(diagram);
                                    });
                                }
                            });
                        }
                        selectedTable.detach();
                        $("#table_remove").hide();
                        $(".dropdown").hide();
                    });

                });
            });

        </script>
    </body>
</html>