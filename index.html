<html>
    <head>
    <link rel="stylesheet" type="text/css" href="resources/styles/style-dark.css">
    <link rel="stylesheet" type="text/css" href="resources/styles/main.css">
    <link href="resources/styles/material-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="resources/styles/materialize.css">
    <script src="resources/jquery-3.5.1.min.js"></script>
    <script src="db-diagram.js"></script>
    <script src="fields.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.7.1/jquery.contextMenu.min.css">
    <script src="resources/jquery.contextMenu.min.js"></script>
    <script src="resources/materialize.min.js"></script>
    </head>
    <body>
        <div id="mydiv" style="width: 100%; height:100%; overflow: scroll"></div>
        <div class="dropdown">
            <div class="menu-content">
            <ul>
                <li><i class="material-icons menu-icon">edit</i> <span>Edit Table</<span></li>
                <li id="add_field"><i class="material-icons menu-icon">add</i> Add Field</li>
                <li><i class="material-icons menu-icon">settings</i> Manage Fields</li>
                <li><i class="material-icons menu-icon">insert_link</i> Manage Relations</li>
                <li><i class="material-icons menu-icon">rule</i> Table Rules</li>
                <li><i class="material-icons menu-icon">remove_circle</i> Remove Table</li>
            </ul>
            </div>
            <div class="arrow"></div>
        </div>
        <div class="popup" id="new_field">
            <div class="popup-container" id="fields">
            </div>
        </div>
        <div class="popup" id="new_table">
            <div class="popup-container">
                <form>
                    <input type="hidden" id="xposition" />
                    <input type="hidden" id="yposition" />
                    <h4>Create New Table (Entity)</h4>
                    <div class="form-group">
                        <input id="tableName" type="text" required="required"/>
                        <label for="input" class="control-label">Table Name</label>
                    </div>
                    <div class="form-group">
                        <textarea id="tableDesc" onfocus="this.placeholder = 'Table description that will be used in your API Documentation'" onblur="this.placeholder = ''"></textarea>
                        <label for="textarea" class="control-label">Description</label><i class="bar"></i>
                    </div>
                    <i class="bar"></i>


                    <details class="feature">
                            <summary class="control-label title-label">Select HTTP Methods to support in this Table:</summary>
                            <div class="row">
                                <div class="checkbox" style="grid-area: first;">
                                    <label>
                                    <input type="checkbox" checked="checked"/><i class="helper"></i>GET
                                    </label>
                                </div>
                                <div class="checkbox" style="grid-area: second;">
                                    <label>
                                    <input type="checkbox" checked="checked"/><i class="helper"></i>POST
                                    </label>
                                </div>
                                <div class="checkbox" style="grid-area: third;">
                                    <label>
                                    <input type="checkbox" checked="checked"/><i class="helper"></i>PUT
                                    </label>
                                </div>
                                <div class="checkbox" style="grid-area: forth;">
                                    <label>
                                    <input type="checkbox" checked="checked"/><i class="helper"></i>DELETE
                                    </label>
                                </div>
                            </div>
                    </details>
                    
                    <details class="feature">
                        <summary class="control-label title-label">Select Table Traits:</summary>
                        <div class="row">
                            <div class="checkbox" style="grid-area: first;">
                                <label>
                                <input type="checkbox" checked="checked"/><i class="helper"></i>Uuid
                                </label>
                            </div>
                            <div class="checkbox" style="grid-area: second;">
                                <label>
                                <input type="checkbox"/><i class="helper"></i>Blameable
                                </label>
                            </div>
                            <div class="checkbox" style="grid-area: third;">
                                <label>
                                <input type="checkbox"/><i class="helper"></i>Timestampable
                                </label>
                            </div>
                            <div class="checkbox" style="grid-area: forth;">
                                <label>
                                <input type="checkbox"/><i class="helper"></i>Softdeletable
                                </label>
                            </div>
                        </div>
                    </details>
                    
                    <details class="feature">
                        <summary class="control-label title-label">Other Options:</summary>
                        <div class="row">
                            <div class="checkbox" style="grid-area: first;">
                                <label>
                                <input type="checkbox" checked="checked"/><i class="helper"></i>Pagination
                                </label>
                            </div>
                            <div class="checkbox" style="grid-area: second;">
                                <label>
                                <input id="requiresAuth" type="checkbox"/><i class="helper"></i>Require Authentication
                                </label>
                            </div>
                        </div>
                    </details>
                    
                    <div class="feature" style="background: beige; display: none; padding-left: 15px;" id="requiresAuthOptions">
                        <div class="row-3">
                            <div class="form-group grid-first">
                                <div class="input-field col s12">
                                    <select id="authReqMethod">
                                        <option value="get" selected>GET</option>
                                        <option value="post" selected>POST</option>
                                        <option value="put" selected>PUT</option>
                                        <option value="delete" selected>DELETE</option>
                                    </select>
                                    <label>Method</label>
                                </div>
                            </div>
                            
                            <div class="form-group grid-second">
                                <div class="input-field col s12">
                                    <select id="authReqEntity">
                                        <option value="users" selected>Users</option>
                                    </select>
                                    <label>Auth Entity</label>
                                </div>
                            </div>
                            <div class="form-group grid-third" style="margin-top: 57px;">
                                <button id="addAuthReq" class="btn waves-effect waves-light" type="submit" name="action">Add
                                    <i class="material-icons right">add_box</i>
                                </button>
                            </div>
                        </div>
                        <div id="chips" class="chips-placeholder chips"></div>

                    </div>
                    
                    <div class="feature" style="padding-left: 15px; padding-right: 15px;">
                        <div class="row">
                            <div class="form-group grid-first" style="padding-right: 10px;">
                                <div class="input-field col s12">
                                    <input id="leftValue" type="text"/>
                                    <label>Left Value</label>
                                </div>
                            </div>
                            
                            <div class="form-group grid-second">
                                <div class="input-field col s12">
                                    <select id="operator">
                                        <option value="==" selected>==</option>
                                        <option value="!=">!=</option>
                                        <option value="===">===</option>
                                        <option value="!==">!==</option>
                                        <option value="<"><</option>
                                        <option value=">">></option>
                                        <option value="<="><=</option>
                                        <option value=">">></option>
                                        <option value=">">></option>
                                    </select>
                                    <label>Operator</label>
                                </div>
                            </div>
                            
                            <div class="form-group grid-third" style="padding-left: 10px; padding-right: 10px;">
                                <div class="input-field col s12">
                                    <input id="rightValue" type="text"/>
                                    <label>Right Value</label>
                                </div>
                            </div>
                            
                            <div class="form-group grid-forth" style="margin-top: 57px;">
                                <button id="addRule" class="btn waves-effect waves-light" type="submit" name="action">Add
                                    <i class="material-icons right">add_box</i>
                                </button>
                            </div>
                        </div>
                        <div id="rule_chips" class="chips-placeholder chips"></div>
                    </div>
                </form>
                <div class="button-container">
                    <button id="addTable" type="button" class="button"><span>Add Table</span></button>
                </div>
            </div>
        </div>
        <script>
            $(document).ready(function() {
                $('select').formSelect();
                DBDiagram.onDomReady(async () => {
                    await DBDiagram.addIconSet("icons.svg");
                    var diagram = new DBDiagram.Diagram({width: '2000px', height: '1500px'}).attach("#mydiv");
                    /*const data = await fetch('https://storage.googleapis.com/krobkrong/sample.table.json')
                    .then((response) => {
                        if (response.ok) return response.json();
                        // handle error here  #61acec
                    });*/
                    let data = [
                        {
                        "name": "table 1",
                        "header": {"tableIcon": "lock", "color": "#010072"},
                        "allowDrag": false,
                        "fields": [
                            {"name": "id", "type": "number", "primary": true},
                            {"name": "name", "type": "string"},
                            {"name": "email", "type": "string"}
                        ],
                        "size" : {"width": "250", "height": "153"}
                        },
                        {
                        "name": "table 2",
                        "header": {"tableIcon": "lock"},
                        "table-icon": "lock",
                        "fields": [
                            {"name": "id", "type": "number", "primary": true, "nameColor": "red"},
                            {"name": "name", "type": "string"},
                            {"name": "email", "type": "string"}
                        ]
                        },
                        {
                        "name": "table 3",
                        "header": {"tableIcon": "lock"},
                        "fields": [
                            {"name": "id", "type": "number", "primary": true},
                            {"name": "name", "type": "string"},
                            {"name": "email", "type": "string"}
                        ]
                        }
                    ];
                    var tables = [];
                    let settingIcon = '<svg class="table-settings-icon" onclick="alert(8787)" fill="#eaeaea" transform="translate(104,5)" width="20" height="20" version="1.1" id="Capa_1" x="{xposition}px" y="7px" viewBox="0 0 384 384" style="enable-background:new 0 0 384 384;" xml:space="preserve"><g>	<g>		<circle cx="192" cy="42.667" r="42.667"/>	</g></g><g>	<g>		<circle cx="192" cy="192" r="42.667"/>	</g></g><g>	<g>		<circle cx="192" cy="341.333" r="42.667"/>	</g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g><g></g></svg>';
                    data.forEach(tbOpt => {
                        const fields = tbOpt.fields;
                        delete tbOpt.fields;
                        tbOpt.size = {width: 250, height: 153};
                        const table = diagram.table(tbOpt);
                        fields.forEach((field) => { table.addField(field) });
                        tables.push(table);
                    });
                
                
                    tables[0].x(100).y(50);
                    tables[1].x(450).y(120);
                    tables[2].x(150).y(320);
                    //tables[0].ne.outerHTML = '<svg xmlns="http://www.w3.org/2000/svg" version="1.1" style="width: 300px; height: 250px"><rect x="50" y="20" rx="10" ry="10" width="200" height="200" style="fill:red; stroke:black; stroke-width:3" id="rect" data-name="table 1" /></svg>';
                        //console.log(tables[0].ne.innerHTML);
                    
                    /*tables[0].onPositionChange = function(pointer) {
                        console.log(pointer);
                        console.log(tables[0].size);
                        let cover = $("#mysvg");
                        cover.css('left', pointer.x);
                        cover.css('top', pointer.y);
                    };*/
                    
                    //newTable.changeName("fff");
                    tables[0].addField({"name": "dddd", "type": "gr"});
                    
                    const relation1 = new DBDiagram.Relation(diagram, {
                        primaryTable: tables[0],
                        foreignTable: tables[1],
                        line: true,
                        weak: false
                    });
                    const relation2 = new DBDiagram.Relation(diagram, {
                        primaryTable: tables[2],
                        foreignField: {foreign: true, name: "email", type: "number", typeRaw: "number"},
                        foreignTable: tables[1],
                        line: false,
                        weak: true,
                        relationType: true,
                        straightLine: true
                    });
                    
                    tables[1].onPointerUp = function() {
                        //e.preventDefault();
                        //alert('jio');
                    };

                    tables.forEach(table => {
                        let settingXPosition = table.size.width - 20;
                        postionedSettingIcon = settingIcon.replace('{xposition}', settingXPosition);
                        let el = $('<g class="wrapped">' + table.ne.innerHTML + '</g>');
                        el.append(postionedSettingIcon);
                        table.ne.innerHTML = el.html();
                    });
                    
                                
                    function unselectAllTables(tables) {
                        if (tables) {
                            tables.forEach(function (table) {
                                table.select(false);
                            });
                        }
                        
                        return true;
                    }
                    
                    function followTable(selected) {
                        let x = (selected.transformMatrix.e + selected.size.width + 15) - $("#mydiv").scrollLeft();
                        let y = (selected.transformMatrix.f + 0) - $("#mydiv").scrollTop();
                        $(".dropdown").css('left', x);
                        $(".dropdown").css('top', y);
                        $(".dropdown").show();
                    }
                    
                    diagram.onTableSelected = function(selected) {
                        if (this.tables) {
                            this.tables.forEach(function (table) {
                                if (table !== selected) {
                                    table.select(false);
                                }
                            });
                        }

                        followTable(selected);
                    };
                    
                    $( "#mydiv" ).scroll(function() {
                        $(".dropdown").fadeOut();
                        unselectAllTables(diagram.tables);
                    });
                    
                    tables.forEach(function (table) {
                        table.onPositionChange = function(p) {
                            this.fieldsUi.forEach(function (item) {
                                if (item.relation && item.relation.length > 0) {
                                    item.relation.forEach(function (relation) {
                                        relation.render();
                                    });
                                }
                            });
                            
                            this.positionx = p.x;
                            this.positiony = p.y;
                            if(this.selected)
                                followTable(this);
                        }
                    });
                    
                    $(".dbdg").click(function() {
                        $(".dropdown").hide();
                        $(".popup").hide();
                    });
                    
                    let arrow = $('.arrow');
                    let menuFirstElement = $(".menu-content").find('ul').children(":first");
                    menuFirstElement.hover(function() {
                        arrow.css('border-right-color', '#8253D7');
                    }, function() {
                        // on mouseout, reset the background colour
                        arrow.css('border-right-color', '#f1f1f1');
                    });
                    
                    
                    $.contextMenu({
                        selector: '.dbdg', 
                        callback: function(key, options) {
                            var currentMousePos = { x: -1, y: -1 };
                            $(document).mousemove(function(event) {
                                currentMousePos.x = event.pageX;
                                currentMousePos.y = event.pageY;
                            });
                            console.log(key);
                            $("#new_table").show();
                        },
                        items: {
                            "new": {name: "New Table", icon: "edit"},
                        }
                    });
                    
                    $(".dbdg").on("contextmenu", function(e) {
                        e.preventDefault();
                        $("#xposition").val(e.pageX);
                        $("#yposition").val(e.pageY);
                        console.log(e.pageX + " " + e.pageY);
                    });
                    
                    
                    var clicked = false, clickY;
                    
                    /*diagram.onDragMove = function(p) {
                        console.log(p);
                        $('html').css('cursor', 'row-resize');
                        $(window).scrollTop($(window).scrollTop() + (50 - p.point.y));
                    };
                    $(document).on({
                        'mousemove': function(e) {
                            clicked && updateScrollPos(e);
                        },
                        'mousedown': function(e) {
                            clicked = true;
                            clickY = e.pageY;
                        },
                        'mouseup': function() {
                            clicked = false;
                            $('html').css('cursor', 'auto');
                        }
                    });*/

                    var updateScrollPos = function(e) {
                        $('html').css('cursor', 'row-resize');
                        $(window).scrollTop($(window).scrollTop() + (clickY - e.pageY));
                    }
                    
                    $("#requiresAuth").change(function() {
                        if(this.checked) {
                            $("#requiresAuthOptions").show();
                        } else {
                            $("#requiresAuthOptions").hide();
                        }
                    });
                    
                    $('#chips').chips(
                        {
                            onChipAdd: function() { $("#chips").show(); },
                            onChipDelete: function() {
                                if($("#chips").children().length <= 1)
                                    $("#chips").hide();
                            }
                        }
                    );
                    
                    $('#rule_chips').chips(
                        {
                            onChipAdd: function() { $("#rule_chips").show(); },
                            onChipDelete: function() {
                                if($("#rule_chips").children().length <= 1)
                                    $("#rule_chips").hide();
                            }
                        }
                    );
                    
                    $("#chips").find("input").prop( "disabled", true );
                    $("#rule_chips").find("input").prop( "disabled", true );
                    
                    $("#authReqMethod").change(function() {
                        $(this).formSelect();
                    });
                    
                    $("#authReqEntity").change(function() {
                        $(this).formSelect();
                    });
                    
                    $("#operator").change(function() {
                        $(this).formSelect();
                    });
                    
                    $("#addAuthReq").click(function(e) {
                        e.preventDefault();
                        let authReqMethod = $('#authReqMethod').formSelect('getSelectedValues');
                        let authReqEntity = $("#authReqEntity").formSelect('getSelectedValues');
                        $('#chips').chips('addChip', {tag: 'Method:' + authReqMethod + ' - Auth:' + authReqEntity, image: ''});
                    });
                    
                    $("#addRule").click(function(e) {
                        e.preventDefault();
                        let operator = $('#operator').formSelect('getSelectedValues');
                        let leftValue = $("#leftValue").val();
                        let rightValue = $("#rightValue").val();
                        if(!leftValue || !rightValue)
                            return false;
                        $("#rule_chips").chips('addChip', {tag: leftValue + ' ' + operator + ' ' + rightValue, image: ''});
                    });
                    
                    $("#addTable").click(function(e) {
                        e.preventDefault();
                        let xposition = $("#xposition").val();
                        let yposition = $("#yposition").val();
                        let tableName = $("#tableName").val();
                        let tbOpt = {
                            "name": tableName,
                            "header": {"tableIcon": "lock", "color": "#010072"},
                            "allowDrag": false,
                            "fields": [
                                {"name": "id", "type": "number", "primary": true},
                                {"name": "name", "type": "string"},
                                {"name": "email", "type": "string"}
                            ],
                            "size" : {"width": "250", "height": "153"}
                        };
                        const fields = tbOpt.fields;
                        delete tbOpt.fields;
                        const table = diagram.table(tbOpt);
                        console.log(diagram.tables);
                        fields.forEach((field) => { table.addField(field) });
                        table.x(xposition).y(yposition);
                    });
                    
                    $("#fields").fields();
                    $("#fields").onAddField = function(field) {
                        console.log("field added: " + field);
                    };
                    
                    $("#add_field").click(function() {
                        $("#new_field").show();
                    });
                    
                    /*tables[1].onPointerUp = function(pointer) {
                        console.log(pointer);
                        alert('hello');
                    };*/
                    
                    /*tables[1].on("click", function (ev) {
                        ev.preventDefault();
                        alert('hi');
                        return false;
                    })*/
                });
            });

        </script>
    </body>
</html>